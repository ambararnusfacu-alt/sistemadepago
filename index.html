<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n Suplementos - Registrar Pago</title>
  <link rel="stylesheet" href="css/stilos.css">
  <style>
    *{box-sizing:border-box} html,body{margin:0;padding:0}
:root{
  --bg:#ffffff; --text:#141518; --muted:#6b7280; --soft:#f7f7f8;
  --border:#e5e7eb; --ink:#111827; --ink2:#000;
  --brand:#0ea5e9; --danger:#ef4444; --ok:#10b981;
}
body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,Segoe UI,Roboto,Arial}

/* =============== Top util bar =============== */
.utilbar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--soft);font-size:14px}
.util-link{color:var(--ink)} .dot{color:var(--muted);margin:0 6px}
.cart-btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}

/* =============== Header =============== */
.header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;padding:18px 16px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:10}
.search{display:flex;gap:8px;max-width:560px}
.search input{flex:1;border:1px solid var(--border);padding:12px 14px;border-radius:10px;background:#fff}
.search button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:12px 14px;cursor:pointer}
.logo{text-align:center;line-height:1}
.logo span{display:block;font-weight:800;letter-spacing:.08em}
.logo small{display:block;color:var(--muted);letter-spacing:.30em;margin-top:2px}
.header-right{display:flex;gap:8px;justify-content:flex-end}
.icon-btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}

/* =============== Nav =============== */
.nav{display:flex;flex-wrap:wrap;gap:14px;padding:10px 16px;border-bottom:1px solid var(--border);background:#fff}
.nav-link{font-size:13px;color:#111827}
.nav-link:hover{color:#000;text-decoration:underline}

/* =============== Tabs internas =============== */
.tabs{display:flex;gap:8px;justify-content:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:76px;z-index:9}
.tab-btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
.tab-btn.active{background:#111827;color:#fff;border-color:#111827}

/* =============== Layout contenido =============== */
.container{max-width:1100px;margin:20px auto;padding:0 16px}
.tab{display:none} .tab.active{display:block}

/* =============== Cards / formularios =============== */
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
label{display:flex;flex-direction:column;font-size:14px}
input,select{margin-top:6px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
.subtle{color:var(--muted);margin-top:8px}

/* =============== Buttons =============== */
.actions,.toolbar{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
.btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
.btn.ghost{background:#fff}
.btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

/* =============== Tablas =============== */
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
th{background:#fafafa}
.right{text-align:right}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#fafafa}
.badge.ok{background:#eafcf2;color:#065f46;border-color:#bbf7d0}
.badge.warn{background:#fff7ed;color:#9a3412;border-color:#fed7aa}

/* =============== Footer =============== */
.footer{padding:20px;border-top:1px solid var(--border);text-align:center;color:var(--muted);background:#fff;margin-top:24px}

/* =============== Responsive =============== */
@media (max-width:900px){ .grid{grid-template-columns:1fr 1fr} .tabs{top:unset} }
@media (max-width:600px){ .grid{grid-template-columns:1fr} }

</style>
</head>

<body>
  <!-- Barra superior -->
  <div class="utilbar">
    <div class="util-left"></div>
    <div class="util-right">
      <a href="#" class="util-link">¬°Hola! Inici√° sesi√≥n</a>
      <span class="dot">¬∑</span>
      <a href="#" class="util-link">o pod√©s registrarte</a>
      <button class="cart-btn" title="Carrito">üõí</button>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <form class="search">
      <input type="search" placeholder="¬øQu√© est√°s buscando?" aria-label="Buscar"/>
      <button type="submit" aria-label="Buscar">üîç</button>
    </form>
    <div class="logo">
      <span>SUPLEMENTACI√ìN</span>
      <small>√ÅMBAR</small>
    </div>
    <div class="header-right">
      <button class="icon-btn" title="Cuenta">üë§</button>
      <button class="icon-btn" title="Notificaciones">üîî</button>
    </div>
  </header>

  <!-- Nav -->
  <nav class="nav">
    <a href="#" class="nav-link">INICIO</a>
    <a href="#" class="nav-link">PRODUCTOS</a>
    <a href="#" class="nav-link">MARCAS</a>
    <a href="#" class="nav-link">COMBOS</a>
    <a href="#" class="nav-link">CREATINA</a>
    <a href="#" class="nav-link">PROTE√çNA</a>
    <a href="#" class="nav-link">QUI√âNES SOMOS</a>
  </nav>

  <!-- Tabs internas -->
  <div class="tabs">
    <button data-tab="empresas" class="tab-btn active">ABM Empresas</button>
    <button data-tab="ventas"   class="tab-btn">Ventas</button>
    <button data-tab="pagos"    class="tab-btn">Registrar Pago</button>
    <button data-tab="reportes" class="tab-btn">Reporte Ventas</button>
  </div>

  <main class="container">
    <!-- ========== EMPRESAS ========== -->
    <section id="empresas" class="tab active">
      <h2>ABM de Empresas</h2>
      <form id="empresaForm" class="card">
        <input type="hidden" id="empresaId"/>
        <div class="grid">
          <label>Nombre
            <input id="empresaNombre" required placeholder="Suplementaci√≥n La Plata"/>
          </label>
          <label>CUIT
            <input id="empresaCuit" placeholder="30-00000000-0"/>
          </label>
          <label>Email
            <input id="empresaEmail" type="email" placeholder="facturacion@empresa.com"/>
          </label>
          <label>Tel√©fono
            <input id="empresaTel" placeholder="+54 9 221..."/>
          </label>
          <label>Estado
            <select id="empresaEstado">
              <option value="1" selected>Activa</option>
              <option value="0">Inactiva</option>
            </select>
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Guardar</button>
          <button type="button" id="empresaCancelar" class="btn ghost">Cancelar</button>
        </div>
      </form>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Nombre</th><th>CUIT</th><th>Email</th><th>Tel√©fono</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="empresaTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ========== VENTAS ========== -->
    <section id="ventas" class="tab">
      <h2>Ventas</h2>
      <form id="ventaForm" class="card" style="margin-top:12px">
        <div class="grid">
          <label>Empresa
            <select id="ventaEmpresa" required></select>
          </label>
          <label>Comprador / Cliente
            <input id="ventaCliente" placeholder="Nombre y apellido" required/>
          </label>
          <label>Medio de Pago
            <select id="ventaMedio" required></select>
          </label>
        </div>

        <h3>√çtems</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Producto</th><th class="right">Cantidad</th><th class="right">Precio Unit.</th><th class="right">Subtotal</th><th></th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
            <tfoot>
              <tr>
                <td colspan="5">
                  <button type="button" id="btnAgregarItem" class="btn">+ Agregar √≠tem</button>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="actions">
          <div style="margin-right:auto;font-weight:600">Total: <span id="ventaTotal">$0,00</span></div>
          <button type="submit" class="btn primary">Aceptar compra</button>
          <button type="button" id="ventaLimpiar" class="btn ghost">Limpiar</button>
        </div>
      </form>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Empresa</th><th>Comprobante</th><th>Fecha</th>
              <th class="right">Neto</th><th class="right">Pagado</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="ventasTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ========== PAGOS (estructura m√≠nima, usa tus IDs si ya ten√≠as el form) ========== -->
    <section id="pagos" class="tab">
      <h2>Registrar Pago</h2>
      <form id="pagoForm" class="card">
        <div class="grid">
          <label>Empresa
            <select id="pagoEmpresa" required></select>
          </label>
          <label>Venta
            <select id="pagoVenta" required></select>
          </label>
          <label>Medio de Pago
            <select id="pagoMedio" required></select>
          </label>
          <label>Monto (ARS)
            <input id="pagoMonto" type="number" min="0" step="0.01" required/>
          </label>
          <label>Referencia / TxID
            <input id="pagoRef" placeholder="N¬∫ operaci√≥n, alias, CAE..."/>
          </label>
          <label>Observaci√≥n
            <input id="pagoObs" placeholder="Se√±a, promo Cuenta DNI, etc."/>
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Aplicar Pago</button>
          <button type="button" id="pagoLimpiar" class="btn ghost">Limpiar</button>
        </div>
        <p class="subtle" id="pagoInfoVenta">Seleccion√° empresa y venta para ver saldo.</p>
      </form>

      <h3>Pagos de la venta</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>ID</th><th>Fecha</th><th>Medio</th><th class="right">Monto</th><th>Ref</th><th>Estado</th><th>Acciones</th></tr>
          </thead>
          <tbody id="pagosTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ========== REPORTE (√öNICA secci√≥n con id="reportes") ========== -->
    <section id="reportes" class="tab">
      <h2>Reporte Ventas</h2>

      <div class="toolbar card">
        <label>Empresa
          <select id="regEmpresa"></select>
        </label>
        <label>Desde
          <input id="regDesde" type="date"/>
        </label>
        <label>Hasta
          <input id="regHasta" type="date"/>
        </label>
        <button id="regFiltrar" class="btn primary" type="button">Filtrar</button>
        <button id="regLimpiar" class="btn ghost" type="button">Limpiar</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Empresa</th>
              <th>Cliente</th>
              <th>Comprobante</th>
              <th class="right">Neto</th>
              <th class="right">Pagado</th>
              <th>Estado</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody id="regTbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="right strong">Totales</td>
              <td id="regTotalNeto" class="right">$0,00</td>
              <td id="regTotalPagado" class="right">$0,00</td>
              <td id="regResumenEstado" colspan="2">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>Tienda de Suplementos ‚Äî M√≥dulo de Facturaci√≥n (Registrar Pago) ‚Äî Demo LocalStorage</small>
  </footer>
</body>


  <script>
    /* ========= TABS ========= */


    function initRegistroVentasUI(){
  // Llenar empresas (con opci√≥n Todas)
  const emps = getLS(KEY.empresas).sort((a,b)=>a.nombre.localeCompare(b.nombre));
  const sel = document.getElementById('regEmpresa');
  if(!sel) return; // si no est√° el HTML, salgo
  sel.innerHTML = `<option value="">(Todas)</option>` +
    emps.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');

  document.getElementById('regFiltrar')?.addEventListener('click', renderRegistroVentas);
  document.getElementById('regLimpiar')?.addEventListener('click', ()=>{
    document.getElementById('regEmpresa').value = '';
    document.getElementById('regDesde').value = '';
    document.getElementById('regHasta').value = '';
    renderRegistroVentas();
  });

  renderRegistroVentas();
}

function renderRegistroVentas(){
  const ventas   = getLS(KEY.ventas);
  const empresas = getLS(KEY.empresas);

  const idEmp  = Number(document.getElementById('regEmpresa')?.value || 0);
  const dDesde = document.getElementById('regDesde')?.value || '';
  const dHasta = document.getElementById('regHasta')?.value || '';

  let lista = ventas.slice().sort((a,b)=> new Date(b.fecha_venta) - new Date(a.fecha_venta));
  if(idEmp) lista = lista.filter(v=> Number(v.id_empresa)===idEmp);
  if(dDesde){
    const d = new Date(dDesde + 'T00:00:00');
    lista = lista.filter(v => new Date(v.fecha_venta) >= d);
  }
  if(dHasta){
    const h = new Date(dHasta + 'T23:59:59');
    lista = lista.filter(v => new Date(v.fecha_venta) <= h);
  }

  const tb = document.getElementById('regTbody');
  if(!tb) return;

  if(lista.length === 0){
    tb.innerHTML = `<tr><td colspan="9" class="subtle">No hay ventas para mostrar.</td></tr>`;
  }else{
    tb.innerHTML = lista.map(v=>{
      const emp = byId(empresas, v.id_empresa)?.nombre || '-';
      const itemsText = (v.items||[]).map(it=>`${it.cantidad} x ${it.producto} ($${it.precio_unit})`).join(' | ');
      const detalleBtn = `<button class="btn ghost" type="button" onclick="verDetalleVenta(${v.id})">Ver</button>`;
      return `<tr>
        <td>${v.id}</td>
        <td>${new Date(v.fecha_venta).toLocaleString()}</td>
        <td>${emp}</td>
        <td>${v.cliente_nombre||''}</td>
        <td>${v.nro_comprobante||''}</td>
        <td class="right">${fmtArs(v.total_neto)}</td>
        <td class="right">${fmtArs(v.total_pagado)}</td>
        <td><span class="badge ${v.estado==='PAGADA'?'ok':'warn'}">${v.estado}</span></td>
        <td>${detalleBtn}<div id="det-${v.id}" class="subtle" style="display:none;margin-top:6px">${itemsText}</div></td>
      </tr>`;
    }).join('');
  }

  const totalNeto   = lista.reduce((a,v)=>a + Number(v.total_neto||0), 0);
  const totalPagado = lista.reduce((a,v)=>a + Number(v.total_pagado||0), 0);
  const ctas = { ABIERTA:0, PARCIAL:0, PAGADA:0 };
  lista.forEach(v=>{ if(ctas[v.estado]!=null) ctas[v.estado]++; });

  const elN = document.getElementById('regTotalNeto');   if(elN) elN.textContent   = fmtArs(totalNeto);
  const elP = document.getElementById('regTotalPagado'); if(elP) elP.textContent   = fmtArs(totalPagado);
  const elE = document.getElementById('regResumenEstado'); 
  if(elE) elE.textContent = `Abiertas: ${ctas.ABIERTA||0} ¬∑ Parciales: ${ctas.PARCIAL||0} ¬∑ Pagadas: ${ctas.PAGADA||0}`;
}

// toggle detalle
window.verDetalleVenta = (id)=>{
  const el = document.getElementById(`det-${id}`);
  if(!el) return;
  el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
};

/* Hook al cambiar de pesta√±a */
(function ensureReportHook(){
  const orig = window.activarTab;
  window.activarTab = function(nombre){
    if (typeof orig === 'function') orig(nombre);
    if (nombre === 'reportes') initRegistroVentasUI();
  };
})();

/* Precarga por si abr√≠s directo la pesta√±a de reportes */
document.addEventListener('DOMContentLoaded', ()=>{
  if (document.querySelector('.tab-btn.active')?.dataset.tab === 'reportes') {
    initRegistroVentasUI();
  }
});
function activarTab(nombre){
  // botones
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${nombre}"]`);
  if (btn) btn.classList.add('active');

  // secciones
  document.querySelectorAll('.tab').forEach(s=>s.classList.remove('active'));
  const sec = document.getElementById(nombre);
  if (sec) sec.classList.add('active');

  // hooks por pesta√±a
  if(nombre === 'empresas'){
    if (typeof renderEmpresas === 'function') renderEmpresas();
  }
  if(nombre === 'ventas'){
    if (typeof initVentaCombos === 'function') initVentaCombos();
    if (!document.querySelector('#itemsBody tr') && typeof addItemRow === 'function') addItemRow();
    if (typeof recalcTotal === 'function') recalcTotal();
    if (typeof renderVentas === 'function') renderVentas();
  }
  if(nombre === 'pagos'){
    if (typeof refillPagoCombos === 'function') refillPagoCombos();
    if (typeof initPagoForm === 'function') initPagoForm();
    if (typeof renderPagosVenta === 'function') renderPagosVenta();
  }

  if (nombre === 'reportes') {
  if (typeof initRegistroVentasUI === 'function') initRegistroVentasUI();
}
}

window.addEventListener('DOMContentLoaded', () => {
  // click en tabs
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      ev.preventDefault(); // por si hay <a> o submit accidental
      activarTab(btn.dataset.tab);
    });
  });
  // pesta√±a inicial
  const btnActivo = document.querySelector('.tab-btn.active');
  activarTab(btnActivo ? btnActivo.dataset.tab : 'empresas');
});


window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const nombre = btn.dataset.tab;
      activarTab(nombre);
    });
  });
  const btnActivo = document.querySelector('.tab-btn.active');
  activarTab(btnActivo ? btnActivo.dataset.tab : 'empresas');
});

/* ========= STORAGE & HELPERS ========= */
const KEY   = { empresas:'fs_empresas', ventas:'fs_ventas', medios:'fs_medios', pagos:'fs_pagos' };
const $     = s => document.querySelector(s);
const $$    = s => document.querySelectorAll(s);
const getLS = (k, d=[]) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const setLS = (k, v)     => localStorage.setItem(k, JSON.stringify(v));
const nextId= arr => arr.length ? Math.max(...arr.map(x=>x.id))+1 : 1;
const nowISO= () => new Date().toISOString();
const fmtArs= n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(Number(n||0));
const byId  = (arr, id) => arr.find(x => Number(x.id)===Number(id));

/* ========= Seeds m√≠nimos ========= */
(function seedMinimo(){
  if(!localStorage.getItem(KEY.empresas)){
    setLS(KEY.empresas, [
      {id:1, nombre:'Suplementaci√≥n La Plata', cuit:'30-12345678-9', email:'ventas@suplaplata.com', telefono:'221-555-5555', estado:1}
    ]);
  }
  if(!localStorage.getItem(KEY.medios)){
    setLS(KEY.medios, [
      {id:1,nombre:'Efectivo',requiere_ref:0},
      {id:2,nombre:'D√©bito',requiere_ref:0},
      {id:3,nombre:'Cr√©dito',requiere_ref:0},
      {id:4,nombre:'Transferencia',requiere_ref:1},
      {id:5,nombre:'QR',requiere_ref:1},
      {id:6,nombre:'Cuenta DNI',requiere_ref:1}
    ]);
  }
  if(!localStorage.getItem(KEY.ventas)){
    setLS(KEY.ventas, []);
  }
  if(!localStorage.getItem(KEY.pagos)){
    setLS(KEY.pagos, []);
  }
})();

/* =========================================================
   EMPRESAS
   ========================================================= */
function renderEmpresas(){
  const empresas = getLS(KEY.empresas);
  const tbody = document.getElementById('empresaTbody');
  if(!tbody) return;
  tbody.innerHTML = empresas.map(e => `
    <tr>
      <td>${e.id}</td>
      <td>${e.nombre}</td>
      <td>${e.cuit||''}</td>
      <td>${e.email||''}</td>
      <td>${e.telefono||''}</td>
      <td><span class="badge ${e.estado? 'ok':'warn'}">${e.estado? 'Activa':'Inactiva'}</span></td>
      <td>
        <button class="btn" data-edit="${e.id}">Editar</button>
        <button class="btn danger" data-del="${e.id}">Eliminar</button>
      </td>
    </tr>
  `).join('');
}

function initABMEventos(){
  const frm = document.getElementById('empresaForm');
  if(!frm) return;

  frm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const empresas = getLS(KEY.empresas);
    const id = Number(document.getElementById('empresaId').value || 0);
    const data = {
      id: id || nextId(empresas),
      nombre:   document.getElementById('empresaNombre').value.trim(),
      cuit:     document.getElementById('empresaCuit')?.value.trim() || '',
      email:    document.getElementById('empresaEmail')?.value.trim() || '',
      telefono: document.getElementById('empresaTel')?.value.trim() || '',
      estado:   Number(document.getElementById('empresaEstado')?.value || 1)
    };
    if(!data.nombre){ alert('El nombre es obligatorio'); return; }

    if(id){
      const i = empresas.findIndex(x=>x.id===id);
      if(i>=0) empresas[i] = {...empresas[i], ...data};
    }else{
      empresas.push(data);
    }
    setLS(KEY.empresas, empresas);
    frm.reset();
    document.getElementById('empresaId').value = '';
    renderEmpresas();
    alert('Empresa guardada.');
    initVentaCombos(); // refresco combos de ventas
  });

  document.getElementById('empresaCancelar')?.addEventListener('click', ()=>{
    frm.reset(); document.getElementById('empresaId').value='';
  });

  document.getElementById('empresaTbody')?.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const empresas = getLS(KEY.empresas);
    if(btn.dataset.edit){
      const id = Number(btn.dataset.edit);
      const e  = empresas.find(x=>x.id===id);
      if(!e) return;
      document.getElementById('empresaId').value = e.id;
      document.getElementById('empresaNombre').value = e.nombre;
      document.getElementById('empresaCuit').value = e.cuit || '';
      document.getElementById('empresaEmail').value = e.email || '';
      document.getElementById('empresaTel').value = e.telefono || '';
      document.getElementById('empresaEstado').value = String(e.estado ?? 1);
      window.scrollTo({top:0, behavior:'smooth'});
    }
    if(btn.dataset.del){
      const id = Number(btn.dataset.del);
      if(!confirm('¬øEliminar empresa?')) return;
      const rest = empresas.filter(x=>x.id!==id);
      setLS(KEY.empresas, rest);
      renderEmpresas();
      initVentaCombos();
    }
  });
}

/* =========================================================
   VENTAS
   ========================================================= */
function initVentaCombos(){
  const empresas = getLS(KEY.empresas).sort((a,b)=>a.nombre.localeCompare(b.nombre));
  const medios   = getLS(KEY.medios);
  const selEmp   = document.getElementById('ventaEmpresa');
  const selMed   = document.getElementById('ventaMedio');
  if(!selEmp || !selMed) return;
  selEmp.innerHTML = empresas.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  selMed.innerHTML = medios.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('');
}

function addItemRow(prod='', cant=1, precio=0){
  const tb = document.getElementById('itemsBody');
  if(!tb) return;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="it-prod" placeholder="Creatina 300g" value="${prod}"/></td>
    <td class="right"><input class="it-cant" type="number" min="1" step="1" value="${cant}" style="max-width:120px"/></td>
    <td class="right"><input class="it-precio" type="number" min="0" step="0.01" value="${precio}" style="max-width:140px"/></td>
    <td class="right"><span class="it-sub">$0,00</span></td>
    <td><button type="button" class="btn danger btn-del">X</button></td>
  `;
  tb.appendChild(tr);
  recalcRow(tr);
  tr.querySelector('.it-cant').addEventListener('input', ()=>recalcRow(tr));
  tr.querySelector('.it-precio').addEventListener('input', ()=>recalcRow(tr));
  tr.querySelector('.btn-del').addEventListener('click', ()=>{ tr.remove(); recalcTotal(); });
}

function recalcRow(tr){
  const cant   = Number(tr.querySelector('.it-cant').value||0);
  const precio = Number(tr.querySelector('.it-precio').value||0);
  const sub    = cant * precio;
  tr.querySelector('.it-sub').textContent = fmtArs(sub);
  recalcTotal();
}

function recalcTotal(){
  let total = 0;
  $$('#itemsBody tr').forEach(tr=>{
    const cant   = Number(tr.querySelector('.it-cant').value||0);
    const precio = Number(tr.querySelector('.it-precio').value||0);
    total += cant * precio;
  });
  const t = document.getElementById('ventaTotal');
  if(t) t.textContent = fmtArs(total);
  return total;
}

function renderVentas(){
  const ventas   = getLS(KEY.ventas);
  const empresas = getLS(KEY.empresas);
  const tb = document.getElementById('ventasTbody');
  if(!tb) return;
  tb.innerHTML = ventas.map(v=>{
    const emp = byId(empresas, v.id_empresa)?.nombre || '-';
    return `<tr>
      <td>${v.id}</td>
      <td>${emp}</td>
      <td>${v.nro_comprobante||''}</td>
      <td>${new Date(v.fecha_venta).toLocaleString()}</td>
      <td class="right">${fmtArs(v.total_neto)}</td>
      <td class="right">${fmtArs(v.total_pagado)}</td>
      <td><span class="badge ${v.estado==='PAGADA'?'ok':'warn'}">${v.estado}</span></td>
      <td></td>
    </tr>`;
  }).join('');
}

/* ===== Submit de la venta (con reglas por medio de pago) ===== */
function handleVentaSubmit(){
  const form = document.getElementById('ventaForm');
  if(!form) return;

  if(!document.querySelector('#itemsBody tr')) addItemRow();

  document.getElementById('btnAgregarItem').addEventListener('click', ()=> addItemRow());
  document.getElementById('ventaLimpiar').addEventListener('click', ()=>{
    document.getElementById('itemsBody').innerHTML = '';
    addItemRow(); recalcTotal(); form.reset(); initVentaCombos();
  });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();

    const id_empresa = Number(document.getElementById('ventaEmpresa').value||0);
    const cliente    = document.getElementById('ventaCliente').value.trim();
    const id_medio   = Number(document.getElementById('ventaMedio').value||0);
    const filas      = Array.from(document.querySelectorAll('#itemsBody tr'));
    if(!id_empresa || !cliente || !id_medio){ alert('Complet√° empresa, cliente y medio de pago.'); return; }
    if(!filas.length){ alert('Agreg√° al menos un √≠tem.'); return; }

    const items = [];
    let total = 0;
    for(const tr of filas){
      const prod   = tr.querySelector('.it-prod').value.trim();
      const cant   = Number(tr.querySelector('.it-cant').value||0);
      const precio = Number(tr.querySelector('.it-precio').value||0);
      if(!prod || cant<=0 || precio<=0) continue;
      const sub = cant * precio;
      total += sub;
      items.push({producto:prod,cantidad:cant,precio_unit:precio,subtotal:sub});
    }
    if(items.length===0){ alert('Los √≠tems est√°n incompletos.'); return; }

    const ventas = getLS(KEY.ventas);
    const medios = getLS(KEY.medios);
    const medio  = medios.find(m=>Number(m.id)===id_medio);

    const id = nextId(ventas);

    // Reglas por medio
    const esEfectivo   = id_medio===1; // Efectivo
    const requiereRef  = !!medio?.requiere_ref;
    const estadoVenta  = esEfectivo ? 'ABIERTA' : 'PAGADA';
    const total_pagado = esEfectivo ? 0 : total;

    let referencia = null;
    if(!esEfectivo && requiereRef){
      const r = prompt('Ingres√° referencia / alias / TxID (opcional):','');
      referencia = r && r.trim()? r.trim(): null;
    }

    const venta = {
      id,
      id_empresa,
      nro_comprobante: `WEB-${String(10000+id)}`,
      fecha_venta: nowISO(),
      cliente_nombre: cliente,
      items,
      total_bruto: total,
      total_descuento: 0,
      total_neto: total,
      total_pagado,
      estado: estadoVenta,
      id_medio_pago: id_medio
    };

    ventas.push(venta);
    setLS(KEY.ventas, ventas);

    // Si NO es efectivo, crear pago autom√°tico por el total
    if(!esEfectivo){
      const pagosArr = getLS(KEY.pagos);
      pagosArr.push({
        id: nextId(pagosArr),
        id_venta: id,
        id_medio: id_medio,
        monto: total,
        moneda: 'ARS',
        fecha_pago: nowISO(),
        referencia: referencia,
        observacion: 'Pago autom√°tico por compra web',
        estado: 'APLICADO'
      });
      setLS(KEY.pagos, pagosArr);
    }

    // Limpiar y refrescar
    form.reset();
    document.getElementById('itemsBody').innerHTML = '';
    addItemRow(); recalcTotal(); initVentaCombos(); renderVentas();

    // Mensaje seg√∫n medio
    if(esEfectivo){
      alert('Compra registrada. Presentate en el local para pagar en efectivo. ¬°Gracias!');
    }else{
      alert('FELICITACIONES COMPRASTE EN SUPLEMENTACIONES AMBAR');
    }
  });
  // despu√©s del alert de √©xito
activarTab('reportes');                 // ir a la pesta√±a Registro de Ventas
if (typeof initRegistroVentasUI === 'function') initRegistroVentasUI();  // asegurar render
if (typeof renderRegistroVentas === 'function') renderRegistroVentas();  // refrescar listado
}

/* =========================================================
   PAGOS (Registrar Pago)
   ========================================================= */
function refillPagoCombos(){
  fillEmpresasCombo('#pagoEmpresa', false);
  fillVentasPorEmpresa();
  const medios = getLS(KEY.medios);
  const sel = document.getElementById('pagoMedio');
  if(sel) sel.innerHTML = medios.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('');
}

function fillEmpresasCombo(selector, incluirTodas){
  const el = document.querySelector(selector);
  const emps = getLS(KEY.empresas).sort((a,b)=>a.nombre.localeCompare(b.nombre));
  if(!el) return;
  el.innerHTML = (incluirTodas?'<option value="">(Todas)</option>':'') +
    emps.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
}

function fillVentasPorEmpresa(){
  const emp   = Number(document.getElementById('pagoEmpresa').value||0);
  const ventas= getLS(KEY.ventas).filter(v=>v.id_empresa===emp && v.estado!=='ANULADA');
  const saldoDe = v => (Number(v.total_neto||0) - Number(v.total_pagado||0));
  const sel = document.getElementById('pagoVenta');
  if(!sel) return;
  sel.innerHTML =
    ventas.map(v=>`<option value="${v.id}">#${v.id} ‚Ä¢ ${v.nro_comprobante||'s/n'} ‚Ä¢ Neto ${fmtArs(v.total_neto)} ‚Ä¢ Saldo ${fmtArs(saldoDe(v))}</option>`).join('');
  showInfoVenta();
  renderPagosVenta();
}

function showInfoVenta(){
  const idV = Number(document.getElementById('pagoVenta').value||0);
  const v   = getLS(KEY.ventas).find(x=>x.id===idV);
  const pInfo = document.getElementById('pagoInfoVenta');
  if(!pInfo) return;
  if(!v){ pInfo.textContent = 'Seleccion√° empresa y venta para ver saldo.'; return; }
  const saldo = (Number(v.total_neto||0) - Number(v.total_pagado||0));
  pInfo.textContent =
    `Venta ${v.nro_comprobante||'#'+v.id} ‚Äî Neto ${fmtArs(v.total_neto)} ‚Äî Pagado ${fmtArs(v.total_pagado)} ‚Äî Saldo ${fmtArs(saldo)} ‚Äî Estado ${v.estado}`;
}

function initPagoForm(){
  const fEmp = document.getElementById('pagoEmpresa');
  const fVen = document.getElementById('pagoVenta');
  const fMed = document.getElementById('pagoMedio');
  const fRef = document.getElementById('pagoRef');
  if(!fEmp || !fVen || !fMed) return; // si no est√° la UI, salgo

  fEmp.addEventListener('change', fillVentasPorEmpresa);
  fVen.addEventListener('change', ()=>{ showInfoVenta(); renderPagosVenta(); });
  fMed.addEventListener('change', ()=>{
    const med = getLS(KEY.medios).find(m=>Number(m.id)===Number(fMed.value));
    if(fRef) fRef.required = !!med?.requiere_ref;
  });

  document.getElementById('pagoForm')?.addEventListener('submit', (e)=>{
    e.preventDefault();

    const idV   = Number(fVen.value||0);
    const ven   = getLS(KEY.ventas).find(v=>v.id===idV);
    if(!ven) return alert('Eleg√≠ una venta v√°lida.');
    if(ven.estado==='ANULADA') return alert('La venta est√° ANULADA');

    const idMed = Number(fMed.value||0);
    const med   = getLS(KEY.medios).find(m=>Number(m.id)===idMed);
    const monto = Number(document.getElementById('pagoMonto').value||0);
    const ref   = fRef?.value.trim() || '';
    const obs   = document.getElementById('pagoObs')?.value.trim() || '';

    if(!idMed || monto<=0) return alert('Medio y monto v√°lidos requeridos.');
    if(med?.requiere_ref && !ref) return alert('Este medio requiere referencia / TxID.');

    const saldo = (Number(ven.total_neto||0) - Number(ven.total_pagado||0));
    if(monto>saldo) return alert(`El pago excede el saldo (${fmtArs(saldo)}).`);

    const pagos = getLS(KEY.pagos);
    pagos.push({
      id: nextId(pagos),
      id_venta: ven.id,
      id_medio: idMed,
      monto,
      moneda:'ARS',
      fecha_pago: nowISO(),
      referencia: ref || null,
      observacion: obs || null,
      estado: 'APLICADO'
    });
    setLS(KEY.pagos, pagos);

    // Actualiza venta
    ven.total_pagado = Number(ven.total_pagado||0) + monto;
    ven.estado = ven.total_pagado >= ven.total_neto ? 'PAGADA' : 'PARCIAL';
    const ventas = getLS(KEY.ventas).map(v=> v.id===ven.id ? ven : v);
    setLS(KEY.ventas, ventas);

    // Reset parcial
    document.getElementById('pagoMonto').value = '';
    if(fRef) fRef.value = '';
    const pObs = document.getElementById('pagoObs'); if(pObs) pObs.value='';
    showInfoVenta(); renderPagosVenta(); renderVentas();
    alert('Pago aplicado.');
  });

  document.getElementById('pagoLimpiar')?.addEventListener('click', ()=>{
    document.getElementById('pagoForm').reset();
    showInfoVenta();
  });
}

function renderPagosVenta(){
  const idV   = Number(document.getElementById('pagoVenta')?.value||0);
  const pagos = getLS(KEY.pagos).filter(p=>p.id_venta===idV);
  const meds  = getLS(KEY.medios);
  const tb    = document.getElementById('pagosTbody');
  if(!tb) return;
  tb.innerHTML = pagos.map(p=>{
    const nom = meds.find(m=>m.id===p.id_medio)?.nombre || '-';
    return `<tr>
      <td>${p.id}</td>
      <td>${new Date(p.fecha_pago).toLocaleString()}</td>
      <td>${nom}</td>
      <td class="right">${fmtArs(p.monto)}</td>
      <td>${p.referencia||''}</td>
      <td>${p.estado}</td>
      <td>${p.estado==='APLICADO'?`<button class="btn danger" onclick="anularPago(${p.id})">Anular</button>`:''}</td>
    </tr>`;
  }).join('');
}

window.anularPago = (idPago)=>{
  if(!confirm('¬øAnular pago?')) return;
  const pagos = getLS(KEY.pagos);
  const p = pagos.find(x=>x.id===idPago); if(!p || p.estado!=='APLICADO') return;
  const ventas = getLS(KEY.ventas);
  const v = ventas.find(x=>x.id===p.id_venta); if(!v) return;

  p.estado='ANULADO';
  v.total_pagado = Math.max(0, Number(v.total_pagado||0) - Number(p.monto||0));
  v.estado = v.total_pagado===0 ? 'ABIERTA' : (v.total_pagado>=v.total_neto ? 'PAGADA' : 'PARCIAL');

  setLS(KEY.pagos, pagos);
  setLS(KEY.ventas, ventas);

  showInfoVenta(); renderPagosVenta(); renderVentas();
};

/* ========= INICIALIZACI√ìN ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // Empresas
  renderEmpresas();
  initABMEventos();

  // Ventas
  initVentaCombos();
  addItemRow();
  recalcTotal();
  handleVentaSubmit();
  renderVentas();
});
function initRegistroVentasUI(){
  // Llena combo empresas (con opci√≥n Todas)
  const emps = getLS(KEY.empresas).sort((a,b)=>a.nombre.localeCompare(b.nombre));
  const sel = document.getElementById('regEmpresa');
  if(!sel) return;
  sel.innerHTML = `<option value="">(Todas)</option>` +
    emps.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');

  // Eventos
  document.getElementById('regFiltrar')?.addEventListener('click', renderRegistroVentas);
  document.getElementById('regLimpiar')?.addEventListener('click', ()=>{
    document.getElementById('regEmpresa').value = '';
    document.getElementById('regDesde').value = '';
    document.getElementById('regHasta').value = '';
    renderRegistroVentas();
  });

  // Primera carga
  renderRegistroVentas();
}

function renderRegistroVentas(){
  const ventas   = getLS(KEY.ventas);
  const empresas = getLS(KEY.empresas);

  const idEmp  = Number(document.getElementById('regEmpresa').value || 0);
  const dDesde = document.getElementById('regDesde').value;
  const dHasta = document.getElementById('regHasta').value;

  // Filtros
  let lista = ventas.slice().sort((a,b)=> new Date(b.fecha_venta) - new Date(a.fecha_venta));
  if(idEmp) lista = lista.filter(v=> Number(v.id_empresa)===idEmp);

  // rango de fechas (inclusive)
  if(dDesde){
    const d = new Date(dDesde + 'T00:00:00');
    lista = lista.filter(v => new Date(v.fecha_venta) >= d);
  }
  if(dHasta){
    const h = new Date(dHasta + 'T23:59:59');
    lista = lista.filter(v => new Date(v.fecha_venta) <= h);
  }

  // render filas
  const tb = document.getElementById('regTbody');
  if(!tb) return;
  tb.innerHTML = lista.map(v=>{
    const emp = byId(empresas, v.id_empresa)?.nombre || '-';
    const itemsText = v.items?.map(it=>`${it.cantidad} x ${it.producto} ($${it.precio_unit})`).join(' | ') || '';
    const detalleBtn = `<button class="btn ghost" type="button" onclick="verDetalleVenta(${v.id})">Ver</button>`;
    return `<tr>
      <td>${v.id}</td>
      <td>${new Date(v.fecha_venta).toLocaleString()}</td>
      <td>${emp}</td>
      <td>${v.cliente_nombre||''}</td>
      <td>${v.nro_comprobante||''}</td>
      <td class="right">${fmtArs(v.total_neto)}</td>
      <td class="right">${fmtArs(v.total_pagado)}</td>
      <td><span class="badge ${v.estado==='PAGADA'?'ok':'warn'}">${v.estado}</span></td>
      <td>${detalleBtn}<div id="det-${v.id}" class="subtle" style="display:none;margin-top:6px">${itemsText}</div></td>
    </tr>`;
  }).join('');

  // totales y resumen de estado
  const totalNeto   = lista.reduce((a,v)=>a + Number(v.total_neto||0), 0);
  const totalPagado = lista.reduce((a,v)=>a + Number(v.total_pagado||0), 0);
  const ctas = { ABIERTA:0, PARCIAL:0, PAGADA:0 };
  lista.forEach(v=>{ if(ctas[v.estado]!=null) ctas[v.estado]++; });

  const rN = document.getElementById('regTotalNeto');   if(rN) rN.textContent   = fmtArs(totalNeto);
  const rP = document.getElementById('regTotalPagado'); if(rP) rP.textContent   = fmtArs(totalPagado);
  const rE = document.getElementById('regResumenEstado'); 
  if(rE) rE.textContent = `Abiertas: ${ctas.ABIERTA||0} ¬∑ Parciales: ${ctas.PARCIAL||0} ¬∑ Pagadas: ${ctas.PAGADA||0}`;
}

// Toggle detalle
window.verDetalleVenta = (id)=>{
  const el = document.getElementById(`det-${id}`);
  if(!el) return;
  el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none';
};
</script>

</html>
